<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Beneficiarios Calificados</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

    <!-- Leaflet.draw (selección por polígono) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
  <script src="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

  <!-- SheetJS (exportar a Excel) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --panel-bg:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e2e8f0;
      --btn:#0f172a;
      --btnText:#ffffff;
      --btnGhost:#ffffff;
      --btnGhostText:#0f172a;
      --shadow: 0 10px 25px rgba(2, 6, 23, 0.10);
      --radius: 14px;
    }

    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; color: var(--text); }
    #app { height: 100%; display: grid; grid-template-columns: 360px 1fr 360px; gap: 0; }

    /* Left panel */
    .panel {
      background: var(--panel-bg);
      border-right: 1px solid var(--border);
      padding: 18px 16px;
      overflow: auto;
    }
    .panel h1 { font-size: 18px; margin: 10px 0 6px; }
    .panel p { margin: 0 0 14px; color: var(--muted); font-size: 13px; line-height: 1.35; }
    .brand {
  display: flex;
  flex-direction: column;   /* ← CLAVE */
  align-items: flex-start;  /* ← CLAVE */
  gap: 6px;
  margin-bottom: 14px;
}
    .brand img { height: 34px; width: auto; display:block; }
    .brand .meta { display:flex; flex-direction:column; }
    .brand .meta .org { font-size: 12px; color: var(--muted); margin-top: 2px; }

    label { display:block; font-size: 12px; color: var(--text); margin: 10px 0 6px; font-weight: 600; }
    select, input {
      width: 100%;
      box-sizing: border-box;
      padding: 10px 10px;
      border: 1px solid var(--border);
      border-radius: 10px;
      outline: none;
      font-size: 14px;
      background: #fff;
    }
    select:disabled { background: #f8fafc; color: #94a3b8; }
    .btn {
      width: 100%;
      padding: 11px 12px;
      margin-top: 10px;
      border-radius: 12px;
      border: 1px solid var(--btn);
      background: var(--btn);
      color: var(--btnText);
      font-weight: 700;
      cursor: pointer;
    }
    .btn:active { transform: translateY(1px); }
    .btn.ghost{
      background: var(--btnGhost);
      color: var(--btnGhostText);
      border-color: var(--border);
      font-weight: 700;
    }

    .stats {
      margin-top: 12px;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: #fff;
      box-shadow: var(--shadow);
      font-size: 13px;
    }
    .stats div { margin: 2px 0; color: var(--muted); }
    .stats b { color: var(--text); }

    .legend {
      margin-top: 12px;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: #fff;
      box-shadow: var(--shadow);
      font-size: 13px;
    }
    .legend h3 { font-size: 12px; margin: 0 0 8px; color: var(--text); }
    .chip { display:flex; align-items:center; gap:10px; margin: 6px 0; color: var(--muted); }
    .dot { width: 12px; height: 12px; border-radius: 999px; display:inline-block; }

    .foot {
      margin-top: 12px;
      font-size: 12px;
      color: var(--muted);
    }

    /* Map */
    #map { height: 100%; width: 100%; }

    /* Right panel */
    .side {
      background: var(--panel-bg);
      border-left: 1px solid var(--border);
      padding: 18px 16px;
      overflow: auto;
    }
    .card {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .card h2 { font-size: 14px; margin: 0 0 10px; }
    .kv { display:grid; grid-template-columns: 120px 1fr; row-gap: 8px; column-gap: 10px; }
    .k { color: var(--muted); font-size: 12px; }
    .v { color: var(--text); font-size: 13px; font-weight: 600; }
    .hint { color: var(--muted); font-size: 13px; line-height:1.35; }

    .rowBtns { display:flex; gap:10px; margin-top: 10px; }
    .rowBtns .btn { margin-top: 0; }
.brand{
  display: flex;
  flex-direction: column;   /* logo arriba, texto abajo */
  align-items: flex-start;
  gap: 6px;
  margin-bottom: 14px;
}

.brand .logo{
  height: 34px;
  width: auto;
}

.brand .title{
  font-size: 18px;
  font-weight: 900;
  margin: 2px 0 0;
  line-height: 1.15;
}

.brand .subtitle{
  font-size: 13px;
  color: #64748b;
  margin: 0;
  line-height: 1.35;
}
    
  </style>
</head>

<body>
<div id="app">

  <!-- Left Panel -->
  <div class="panel">
<div class="brand">
  <img src="logo_institucional.jpg" alt="Logo institucional" class="logo">

  <h1 class="title">BENEFICIARIOS PICHINCHA - GUAYAS</h1>

  <p class="subtitle">
    Filtra por provincia, cantón y planificación. Haz clic en un punto para ver el detalle a la derecha.
  </p>
</div>

    <label for="provSel">Provincia</label>
    <select id="provSel">
      <option value="__all__">(Todas)</option>
    </select>

    <label for="cantSel">Cantón</label>
    <select id="cantSel" disabled>
      <option value="__all__">(Todos)</option>
    </select>

    <label for="searchBox">Buscar (CI / Apellidos / Nombres)</label>
    <input id="searchBox" type="text" placeholder="Ej: 0910..., CRUZ, ENSON..." />

    <button id="btnClear" class="btn ghost">Limpiar</button>

        <!-- Selección por polígono + export -->
    <button id="btnSelectMode" class="btn ghost">Seleccionar beneficiarios</button>
    <button id="btnDownloadSel" class="btn" disabled>Descargar beneficiarios seleccionados</button>
    <button id="btnClearSel" class="btn ghost" disabled>Quitar selección</button>
    <div id="selInfo" class="foot" style="margin-top:8px;"></div>

    <div class="stats" id="stats">
      <div><b>Total:</b> <span id="totalCount">0</span></div>
      <div><b>Mostrando:</b> <span id="shownCount">0</span></div>
      <div>Provincia: <b id="statProv">(Todas)</b></div>
      <div>Cantón: <b id="statCant">(Todos)</b></div>
      <div>Búsqueda: <b id="statSearch">(Ninguna)</b></div>
    </div>

    <div class="legend">
      <h3>Leyenda (Provincia)</h3>
      <div class="chip"><span class="dot" id="dotPich"></span> Pichincha</div>
      <div class="chip"><span class="dot" id="dotGua"></span> Guayas</div>
    </div>

    <div class="foot">Fuente: Base depurada de beneficiarios calificados (GeoJSON).</div>
  </div>

  <!-- Map -->
  <div id="map"></div>

  <!-- Right Panel -->
  <div class="side">
    <div class="card">
      <h2>DETALLE DEL BENEFICIARIO</h2>
      <div id="detailEmpty" class="hint">Selecciona un punto en el mapa para ver su información.</div>

      <div id="detailBox" style="display:none;">
        <div class="kv">
          <div class="k">Apellidos</div><div class="v" id="d_apellidos">—</div>
          <div class="k">Nombres</div><div class="v" id="d_nombres">—</div>
          <div class="k">Puntaje Registro Social</div><div class="v" id="d_puntaje">—</div>
          <div class="k">Provincia</div><div class="v" id="d_prov">—</div>
          <div class="k">Cantón</div><div class="v" id="d_cant">—</div>
        </div>

        <div class="rowBtns">
          <button id="btnCenter" class="btn">Centrar</button>
          <button id="btnUnselect" class="btn ghost">Quitar selección</button>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
  // ======= CONFIG =======
  const GEOJSON_FILE = "Beneficiarios_Pichincha_Guayas.geojson";

  // Colores por provincia (puedes cambiar si quieres)
  const COLORS = {
    "Pichincha": "#2563eb", // azul
    "Guayas": "#16a34a"     // verde
  };

  // Vista inicial aproximada Ecuador
  const ECUADOR_VIEW = { center: [-1.5, -78.2], zoom: 6 };

  // ======= MAP INIT =======
  const map = L.map("map", { zoomControl: true }).setView(ECUADOR_VIEW.center, ECUADOR_VIEW.zoom);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  // ======= UI ELEMENTS =======
  const provSel = document.getElementById("provSel");
  const cantSel = document.getElementById("cantSel");
  const searchBox = document.getElementById("searchBox");
  const btnClear = document.getElementById("btnClear");

    // Selección por polígono (UI)
  const btnSelectMode = document.getElementById("btnSelectMode");
  const btnDownloadSel = document.getElementById("btnDownloadSel");
  const btnClearSel = document.getElementById("btnClearSel");
  const selInfo = document.getElementById("selInfo");

  const totalCountEl = document.getElementById("totalCount");
  const shownCountEl = document.getElementById("shownCount");
  const statProvEl = document.getElementById("statProv");
  const statCantEl = document.getElementById("statCant");
  const statSearchEl = document.getElementById("statSearch");

  document.getElementById("dotPich").style.background = COLORS["Pichincha"];
  document.getElementById("dotGua").style.background = COLORS["Guayas"];

  // Detail elements
  const detailEmpty = document.getElementById("detailEmpty");
  const detailBox = document.getElementById("detailBox");
  const d_apellidos = document.getElementById("d_apellidos");
  const d_nombres = document.getElementById("d_nombres");
  const d_puntaje = document.getElementById("d_puntaje");
  const d_prov = document.getElementById("d_prov");
  const d_cant = document.getElementById("d_cant");
  const btnCenter = document.getElementById("btnCenter");
  const btnUnselect = document.getElementById("btnUnselect");

  // ======= STATE =======
  let rawFeatures = [];
  let layerGroup = L.layerGroup().addTo(map);
  let selectedMarker = null;
  let selectedLatLng = null;

    // ======= SELECCIÓN POR POLÍGONO (STATE) =======
  let selectionMode = false;                 // si está activo, clic no abre detalle
  let selectedMarkersSet = new Set();        // marcadores seleccionados
  let selectedRows = [];                     // filas (properties) seleccionadas
  let lastDrawnLayer = null;                 // polígono actual

  // Capa donde se dibuja el polígono
  const drawnItems = new L.FeatureGroup();
  map.addLayer(drawnItems);

  // Control draw (no usamos toolbar; lo activamos por botón)
  const drawControl = new L.Control.Draw({
    edit: { featureGroup: drawnItems, edit: false, remove: false },
    draw: {
      polygon: {
        allowIntersection: false,
        showArea: true,
        shapeOptions: { weight: 2 }
      },
      polyline: false,
      rectangle: false,
      circle: false,
      circlemarker: false,
      marker: false
    }
  });
  map.addControl(drawControl);

  function setSelInfo(msg){
    selInfo.textContent = msg || "";
  }

  function setSelButtons(){
    btnDownloadSel.disabled = selectedRows.length === 0;
    btnClearSel.disabled = (!selectionMode && selectedRows.length === 0 && drawnItems.getLayers().length === 0);
    btnSelectMode.textContent = selectionMode ? "Dibujando selección… (clic para cancelar)" : "Seleccionar beneficiarios";
  }

  function styleMarkerSelected(marker, yes){
    marker.setStyle({
      weight: yes ? 3 : 1,
      opacity: 1,
      fillOpacity: yes ? 0.98 : 0.85
    });
  }

  function clearPolygonSelectionAll(){
    // limpia selección y polígono, vuelve a modo normal
    selectionMode = false;

    selectedMarkersSet.forEach(m => styleMarkerSelected(m, false));
    selectedMarkersSet.clear();
    selectedRows = [];

    drawnItems.clearLayers();
    lastDrawnLayer = null;

    setSelInfo("");
    setSelButtons();
  }

  // Ray casting: punto dentro de polígono
  function pointInPolygon(point, vs){
    const x = point.lng, y = point.lat;
    let inside = false;
    for (let i = 0, j = vs.length - 1; i < vs.length; j = i++) {
      const xi = vs[i].lng, yi = vs[i].lat;
      const xj = vs[j].lng, yj = vs[j].lat;

      const intersect = ((yi > y) !== (yj > y)) &&
        (x < (xj - xi) * (y - yi) / ((yj - yi) || 1e-12) + xi);

      if (intersect) inside = !inside;
    }
    return inside;
  }

  function getPolygonLatLngs(layer){
    const latlngs = layer.getLatLngs();
    return Array.isArray(latlngs[0]) ? latlngs[0] : latlngs;
  }

  function startPolygonDrawing(){
    drawnItems.clearLayers();
    lastDrawnLayer = null;

    setSelInfo("Dibuja un polígono sobre el mapa para seleccionar beneficiarios.");
    setSelButtons();

    const drawer = new L.Draw.Polygon(map, drawControl.options.draw.polygon);
    drawer.enable();
  }

  function exportSelectedToExcel(){
    if (selectedRows.length === 0) return;

    const rowsForExcel = selectedRows.map(props => ({
      CI: normStr(props.cedula ?? props.CEDULA ?? props.ci ?? props.CI),
      Apellidos: normStr(props.apellidos ?? props.Apellidos ?? props.APELLIDOS),
      Nombres: normStr(props.nombres ?? props.Nombres ?? props.NOMBRES),
      Puntaje: getPuntaje(props),
      Provincia: getProv(props),
      Canton: getCant(props),
      Planificacion: normStr(props.planificacion ?? props.Planificacion ?? props.PLANIFICACION ?? props.PLANIFICACIÓN)
    }));

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(rowsForExcel);
    XLSX.utils.book_append_sheet(wb, ws, "Seleccionados");
    XLSX.writeFile(wb, "beneficiarios_seleccionados.xlsx");
  }
  
  // ======= HELPERS =======
  function normStr(v){
    return (v ?? "").toString().trim();
  }
  function getProv(props){
    // Prefer PROVINCIA field already in your table
    return normStr(props.PROVINCIA) || normStr(props.provincia) || normStr(props.Provincia);
  }
  function getCant(props){
    return normStr(props.CANTON) || normStr(props.canton) || normStr(props.Cantón) || normStr(props.Canton);
  }
  function getPuntaje(props){
    // puntaje puede venir como string o número
    const p = props.puntaje ?? props.PUNTAJE ?? props.Puntaje;
    if (p === null || p === undefined || p === "") return "";
    // mantener tal cual pero con coma/punto consistente
    const num = Number(p);
    if (Number.isFinite(num)) return num.toString().replace(".", ",");
    return normStr(p);
  }
  function markerColorByProv(prov){
    return COLORS[prov] || "#7c3aed"; // morado fallback
  }

  function uniqueSorted(arr){
    return Array.from(new Set(arr)).filter(v => v).sort((a,b)=>a.localeCompare(b,"es"));
  }

  function clearSelection(){
    selectedMarker = null;
    selectedLatLng = null;
    detailBox.style.display = "none";
    detailEmpty.style.display = "block";
  }

  function setDetailFromProps(props, latlng){
    const ap = normStr(props.apellidos ?? props.Apellidos ?? props.APELLIDOS);
    const no = normStr(props.nombres ?? props.Nombres ?? props.NOMBRES);
    const pr = getProv(props);
    const ca = getCant(props);
    const pu = getPuntaje(props);

    d_apellidos.textContent = ap || "—";
    d_nombres.textContent = no || "—";
    d_puntaje.textContent = pu || "—";
    d_prov.textContent = pr || "—";
    d_cant.textContent = ca || "—";

    selectedLatLng = latlng;

    detailEmpty.style.display = "none";
    detailBox.style.display = "block";
  }

  function fitToLayer(layer){
    const b = layer.getBounds && layer.getBounds();
    if (b && b.isValid && b.isValid()){
      map.fitBounds(b, { padding: [40, 40] });
      return true;
    }
    return false;
  }

  // ======= FILTER LOGIC =======
  function populateProvinceOptions(){
    const provs = uniqueSorted(rawFeatures.map(f => getProv(f.properties)));
    // Solo Pichincha y Guayas (si por cualquier motivo hay otro, lo listará)
    provSel.innerHTML = `<option value="__all__">(Todas)</option>` +
      provs.map(p => `<option value="${p}">${p}</option>`).join("");
  }

  function populateCantonOptionsForProvince(prov){
    if (!prov || prov === "__all__"){
      cantSel.disabled = true;
      cantSel.innerHTML = `<option value="__all__">(Todos)</option>`;
      return;
    }
    const cantons = uniqueSorted(
      rawFeatures
        .filter(f => getProv(f.properties) === prov)
        .map(f => getCant(f.properties))
    );

    cantSel.disabled = false;
    cantSel.innerHTML = `<option value="__all__">(Todos)</option>` +
      cantons.map(c => `<option value="${c}">${c}</option>`).join("");
  }

  function applyFilters(){
    clearSelection();

        clearPolygonSelectionAll();

    const prov = provSel.value;
    const cant = cantSel.value;
    const q = normStr(searchBox.value).toLowerCase();

    let filtered = rawFeatures.slice();

    if (prov !== "__all__"){
      filtered = filtered.filter(f => getProv(f.properties) === prov);
    }
    if (!cantSel.disabled && cant !== "__all__"){
      filtered = filtered.filter(f => getCant(f.properties) === cant);
    }
    if (q){
      filtered = filtered.filter(f => {
        const props = f.properties || {};
        const ci = normStr(props.cedula ?? props.CEDULA ?? props.ci ?? props.CI);
        const ap = normStr(props.apellidos ?? props.Apellidos ?? props.APELLIDOS);
        const no = normStr(props.nombres ?? props.Nombres ?? props.NOMBRES);
        const blob = (ci + " " + ap + " " + no).toLowerCase();
        return blob.includes(q);
      });
    }

    // Update stats
    statProvEl.textContent = (prov === "__all__") ? "(Todas)" : prov;
    statCantEl.textContent = (cantSel.disabled || cant === "__all__") ? "(Todos)" : cant;
    statSearchEl.textContent = q ? `"${searchBox.value}"` : "(Ninguna)";
    shownCountEl.textContent = filtered.length.toString();

    // Repaint layer
    layerGroup.clearLayers();

    const geoLayer = L.geoJSON({ type: "FeatureCollection", features: filtered }, {
      pointToLayer: (feature, latlng) => {
        const p = getProv(feature.properties || {});
        const color = markerColorByProv(p);

        const marker = L.circleMarker(latlng, {
          radius: 6,
          weight: 1,
          color: "#111827",
          opacity: 0.8,
          fillColor: color,
          fillOpacity: 0.85
        });

        
        // Guardamos properties para export
        marker.__props = (feature.properties || {});
        marker.__latlng = latlng;

        marker.on("click", () => {
          // Si está activo el modo selección: toggle selección por clic (opcional)
          if (selectionMode){
            if (selectedMarkersSet.has(marker)){
              selectedMarkersSet.delete(marker);
              styleMarkerSelected(marker, false);
            } else {
              selectedMarkersSet.add(marker);
              styleMarkerSelected(marker, true);
            }

            selectedRows = Array.from(selectedMarkersSet).map(m => m.__props || {});
            setSelInfo(`Seleccionados: ${selectedRows.length}`);
            setSelButtons();
            return; // NO abrir detalle
          }

          // Modo normal: abre detalle como antes
          selectedMarker = marker;
          setDetailFromProps(marker.__props || {}, latlng);
        });

        
        return marker;
      }
    });

    geoLayer.addTo(layerGroup);

    // Zoom automático si hay filtros o búsqueda
    const hasAnyFilter = (prov !== "__all__") || (!cantSel.disabled && cant !== "__all__") || !!q;
    if (hasAnyFilter){
      const did = fitToLayer(geoLayer);
      if (!did) map.setView(ECUADOR_VIEW.center, ECUADOR_VIEW.zoom);
    } else {
      map.setView(ECUADOR_VIEW.center, ECUADOR_VIEW.zoom);
    }
  }

  // ======= EVENTS =======
  provSel.addEventListener("change", () => {
    populateCantonOptionsForProvince(provSel.value);
    // reset cantón cuando cambia provincia
    cantSel.value = "__all__";
    applyFilters();
  });

  cantSel.addEventListener("change", () => applyFilters());

  let searchTimer = null;
  searchBox.addEventListener("input", () => {
    clearTimeout(searchTimer);
    searchTimer = setTimeout(applyFilters, 220);
  });

  btnClear.addEventListener("click", () => {
    provSel.value = "__all__";
    populateCantonOptionsForProvince("__all__");
    cantSel.value = "__all__";
    searchBox.value = "";
    applyFilters();
  });

  btnCenter.addEventListener("click", () => {
    if (selectedLatLng){
      map.setView(selectedLatLng, Math.max(map.getZoom(), 14));
    }
  });

  btnUnselect.addEventListener("click", () => {
    clearSelection();
  });

  // ======= LOAD DATA =======
  fetch(GEOJSON_FILE)
    .then(r => {
      if (!r.ok) throw new Error("No se pudo cargar el GeoJSON: " + GEOJSON_FILE);
      return r.json();
    })
    .then(data => {
      if (!data || !data.features) throw new Error("GeoJSON inválido (sin features).");

      rawFeatures = data.features.filter(f => f && f.geometry && f.geometry.type && f.properties);
      totalCountEl.textContent = rawFeatures.length.toString();

      populateProvinceOptions();
      populateCantonOptionsForProvince("__all__");

      // Primera pintura
      applyFilters();
    })
    .catch(err => {
      console.error(err);
      alert("Error cargando datos. Revisa que el archivo exista y se llame exactamente: " + GEOJSON_FILE);
    });
</script>
</body>
</html>













